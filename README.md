# Flight Mission — Полётное задание

## Описание

Flight Mission — интерактивное веб‑приложение для построения полётных маршрутов с учётом запретных зон (no‑fly zones) и рельефа местности. Позволяет:

* Выбирать начало и конец маршрута на карте или вводить координаты вручную.
* Рисовать и редактировать зоны запрета полёта (полигоны) с помощью Geoman.
* Задавать ширину коридора (буфера) вокруг маршрута.
* Автоматически обходить препятствия и рассчитывать оптимальный путь (A\*).
* Экспортировать готовый маршрут в файл **KML**, совместимый с QGroundControl.

## Функциональность

1. **Интерактивная карта** на базе MapLibre GL:

   * Спутниковые тайлы и DEM (terrain‑RGB) от MapTiler.
   * Навигационные контролы (прицел, зум, вращение).
   * Перекрестие (crosshair) для точного выбора точек.

2. **Редактирование зон no‑fly**:

   * Рисование полигонов, линий, кругов и прямоугольников.
   * Стилизация заливки и контура.

3. **Построение маршрута**:

   * Серверный API `/api/route` (Next.js API Routes).
   * Алгоритм в `src/utils/routeUtils.js`:

     1. Буферизация запретных зон и создание графа видимости.
     2. A\*‑поиск кратчайшего пути.
     3. Возвращение GeoJSON LineString маршрута и Polygon коридора.

4. **Редактирование маршрута на клиенте**:

   * Интеграция Geoman для глобального редактирования пути.
   * Автоматическое обновление коридора при перетаскивании вершин.

5. **Экспорт KML**:

   * После построения маршрута в правой части верхней панели (рядом с логотипом) появляется кнопка **«Экспорт KML»**.
   * Скачивает `testMission.kml` с маршрутами‑вейпоинтами и линейной трассой:

     * Точки с Alt AMSL и Alt Rel.
     * `LookAt` для центрирования при открытии.
     * `absolute` altitudeMode.

## Установка и запуск

```bash
# Клонировать репозиторий
git clone https://github.com/ваш_пользователь/flight-mission.git
cd flight-mission

# Установить зависимости (pnpm)
pnpm install

# Задать ключ MapTiler (terrain и спутник)
export NEXT_PUBLIC_MAPTILER_KEY=ваш_ключ

# Запуск приложения в режиме разработки
pnpm dev
```

Приложение будет доступно на `http://localhost:3000`.

## API маршрутизатора

**POST** `/api/route` — рассчитывает маршрут.

**Тело запроса** (JSON):

```json
{
  "start": [lon, lat],
  "end":   [lon, lat],
  "noFlyZones": [ /* GeoJSON Polygon */ ],
  "corridorWidth": 50  // в метрах
}
```

**Ответ 200 OK**:

```json
{
  "route": { /* GeoJSON LineString */ },
  "corridor": { /* GeoJSON Polygon */ }
}
```

## Алгоритм построения маршрута

1. Буферизация зон запрета полёта.
2. Проверка прямого соединения (если не пересекает зоны).
3. Сбор узлов (старт, финиш, вершины полигонов).
4. Построение графа рёбер видимости (Turf.js).
5. A\*‑поиск кратчайшего пути (heap).
6. Формирование GeoJSON и расчёт длины.

Подробнее в [`src/utils/routeUtils.js`](src/utils/routeUtils.js).

## Редактирование на клиенте

* **MapComponent.jsx** реализует:

  * Инициализацию карты и Geoman.
  * Панель выбора начала/конца маршрута.
  * Маркеры и перекрестие для выбора.
  * Кнопку экспорта и сохранение маршрута в контексте.
* **RouteContext.js** хранит текущее состояние маршрута для экспорта.

## Экспорт KML

Кнопка **«Экспорт KML»** появляется только после того, как маршрут построен (и сохранён в `RouteContext`). При клике скачивается `testMission.kml`:

* **Placemark** для каждой точки с `Alt AMSL` и `Alt Rel`.
* **LineString** с `extrude`, `tessellate` и `absolute` высотами.
* **LookAt** — центр карты при импортировании.

## Тестирование

Автоматические тесты настроены на **Jest**.

```bash
pnpm test
```

Тесты в `__tests__/routeUtils.test.js` проверяют:

* Прямой маршрут без зон.
* Обход круглой зоны.
* Отсутствие маршрута при полном блоке зон.

---

© 2025 Flight Mission. MIT License.
