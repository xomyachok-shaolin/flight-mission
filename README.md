# Проект Flight Mission

**Flight Mission** — интерактивное приложение для построения маршрутов с учётом запретных зон (no‑fly zones) и расчётом коридора полёта.

## Основные возможности

* **Интерактивная карта** на базе MapLibre GL с контролем навигации и ландшафта.
* **Рисование** запретных зон (полигонов) пользователем через Geoman.
* **Построение маршрута** между двумя точками, обходя зоны неразрешённого полёта.
* **Буферизация** маршрута (коридор) по заданной ширине.
* **Редактирование** готового маршрута: перемещение вершин и мгновенный пересчёт коридора.
* **A\***-алгоритм поиска оптимального обхода препятствий при необходимости.
* **Автоматические тесты** для проверки корректности работы маршрутизатора.

## Установка и запуск

```bash
# Клонируем репозиторий
git clone https://github.com/ваш_пользователь/flight-mission.git
cd flight-mission

# Устанавливаем зависимости
pnpm install

# Устанавливаем ключ MapTiler
export NEXT_PUBLIC_MAPTILER_KEY=ваш_ключ

# Запускаем в режиме разработки
pnpm dev
```

Приложение будет доступно по адресу `http://localhost:3000`.

## API маршрутизатора

Серверная часть предоставляет endpoint:

```
POST /api/route
```

**Тело запроса** (JSON):

```json
{
  "start": [lon, lat],          // координаты начала
  "end":   [lon, lat],          // координаты конца
  "noFlyZones": [...],          // массив GeoJSON-полигонов
  "corridorWidth": число,       // ширина буфера в метрах
  "maxAltitude": число          // (опционально) ограничение по высоте
}
```

**Ответ** (200 OK):

```json
{
  "route":   <GeoJSON LineString>,
  "corridor":<GeoJSON Polygon>
}
```

Вернёт `404` если маршрут не найден, или `500` при внутренней ошибке.

## Алгоритм построения маршрута

В `src/utils/routeUtils.js` реализован `computeRoute(start, end, noFlyZones, corridorWidth)`:

1. **Буферизация** зон опасности с запасом EPS (1 мм) + ширина коридора.
2. **Простая проверка**: если прямой сегмент не входит в буферы — возвращаем его.
3. **Сбор узлов**: начало, конец и вершины буферизованных полигонов.
4. **Фильтрация узлов**: отбрасываем те, что строго внутри зон.
5. **Построение графа**:

   * Рёбра между всеми «видимыми» парами точек,
   * Рёбра по контуру каждого буферизованного полигона,
   * Стоимость ребра = длина сегмента в метрах.
6. **A\***: поиск кратчайшего пути по графу.
7. **Сборка GeoJSON** итогового маршрута.

Поддерживаются случаи:

* Прямая без зон.
* Обход одиночной или нескольких зон.
* Отсечение точки старта/финиша, попавших внутрь зон.

## Редактирование на клиенте

В `src/components/MapComponent.jsx`:

* **Geoman** интегрирован для рисования и редактирования.
* При изменении маршрута через Geoman мгновенно пересчитывается полигон коридора.
* Маркеры начала/конца сохраняются при закрытии панели.
* Поддержка отмены/повтора операций.

## Тесты

```bash
pnpm test
```

Файл `__tests__/routeUtils.test.js` проверяет:

1. Прямая линия без зон.
2. Обход круглой зоны (не пересекать).
3. Полная блокировка (возврат `null`).

---
